<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Parking System</title>
<style>
body{font-family:Segoe UI;background:#f0f2f5;margin:0;padding:0}
header{background:#1E90FF;color:#fff;text-align:center;padding:18px;font-size:24px}
.container{max-width:800px;margin:25px auto;background:#fff;padding:20px;border-radius:10px}
button{background:#1E90FF;color:#fff;border:0;padding:10px;border-radius:6px;cursor:pointer}
#galleryModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center}
#galleryImg{max-width:90%;max-height:90%;border:4px solid #fff}
img.thumb{width:80px;height:auto;cursor:pointer;margin:4px;border:2px solid #1E90FF;border-radius:6px}
</style>
</head>
<body>
<header>Parking Violations Dashboard</header>
<div class="container">

<h3>Upload Car Image</h3>
<input type="file" id="carImage"><button onclick="uploadImage()">Submit</button>
<div id="imgMsg"></div><hr>

<h3>Search Vehicle</h3>
<input id="searchPlate" placeholder="Vehicle number"><button onclick="searchVeh()">Search</button>
<div id="res"></div><hr>

<h3>Pay Fine</h3>
<input id="payPlate" placeholder="Vehicle number">
<input type="number" id="payAmt" placeholder="Amount">
<button onclick="payFine()">Pay</button>
<div id="payMsg"></div>
</div>

<div id="galleryModal" onclick="this.style.display='none'">
<img id="galleryImg">
</div>

<script>
const api = "http://127.0.0.1:8000";

async function uploadImage(){
    let f=document.getElementById("carImage").files[0];
    if(!f) return;
    let fd=new FormData(); fd.append("file",f);
    let r=await fetch(api+"/api/new_violation_image",{method:"POST",body:fd});
    let d=await r.json();
    imgMsg.innerText=JSON.stringify(d);
}

async function searchVeh(){
    let p=document.getElementById("searchPlate").value.trim();
    let r=await fetch(api+"/api/get_vehicle/"+p);
    let d=await r.json();
    if(d.status!=="found"){res.innerText="No record";return;}

    let h=`<h4>Remaining Due: â‚¹${d.record.fine}</h4><table border=1><tr><th>Type</th><th>Amount</th><th>Time</th><th>Evidence</th></tr>`;
    d.record.breakdown.forEach(v=>{
        h+=`<tr><td>${v.type}</td><td>${v.amount}</td><td>${v.timestamp}</td>
        <td>${v.image?`<img class='thumb' onclick='openPopup(this.src)' src="data:image/jpeg;base64,${v.image}">`:''}</td></tr>`;
    });
    h+="</table>";
    res.innerHTML=h;
}

function openPopup(src){
    galleryModal.style.display="flex";
    galleryImg.src=src;
}

async function payFine(){
    let n=payPlate.value.trim(),a=Number(payAmt.value);
    let r=await fetch(api+"/api/pay_fine",{method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({number:n,amount:a})});
    let d=await r.json();
    payMsg.innerText=JSON.stringify(d);
}
</script>
</body>
</html>
