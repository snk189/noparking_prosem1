<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Traffic Violations</title>
<style>
body{font-family:Segoe UI;background:#f0f2f5;margin:0}
header{background:#0077ff;color:#fff;text-align:center;padding:18px;font-size:24px}
.container{max-width:900px;margin:25px auto;background:#fff;padding:20px;border-radius:10px}
button{background:#0077ff;color:#fff;border:0;padding:10px;border-radius:6px;cursor:pointer;margin-top:6px}
img.thumb{width:90px;border:2px solid #0077ff;margin:4px;cursor:pointer;border-radius:6px}
#modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:9999}
#modal img{max-width:90%;max-height:90%;border:5px solid #fff;border-radius:8px}
.statusGreen{color:green;font-weight:bold;font-size:18px}
.statusRed{color:red;font-weight:bold;font-size:18px}
input[type=date], input[type=time]{padding:6px;margin:4px;border-radius:5px;border:1px solid #ccc;}
table{border-collapse:collapse;width:100%}
th,td{padding:6px;text-align:center;border:1px solid #ccc;}
</style>
</head>
<body>
<header>Parking & Traffic Violation Dashboard</header>
<div class="container">

<h3>Upload Car Image</h3>
<input type="file" id="img"><button onclick="add()">Submit</button>
<div id="msg"></div><hr>

<h3>Search Vehicle</h3>
<input id="num" placeholder="KA01AB1234"><br>
Start Date: <input type="date" id="startDate"> Start Time: <input type="time" id="startTime">
<button onclick="fetchData()">Search</button>
<div id="res"></div><hr>

<h3>Pay Fine</h3>
<input id="pnum" placeholder="KA01AB1234">
<input type="number" id="amt" placeholder="Amount">
<button onclick="pay()">Pay</button>
<div id="paymsg"></div><hr>

<h3>Recent 5 Violations</h3>
<div id="recent"></div>

</div>

<div id="modal" onclick="this.style.display='none'"><img id="big"></div>

<script>
const api="http://127.0.0.1:8000";

async function add(){
 let f=img.files[0]; if(!f) return;
 let fd=new FormData(); fd.append("file",f);
 let r=await fetch(api+"/api/new_violation_image",{method:"POST",body:fd});
 let d=await r.json();
 if(d.status==='wait'){ msg.innerText=d.message; return; }
 if(d.status==='error'){ msg.innerText=d.message; return; }
 msg.innerText=`Plate: ${d.plate} | Fine: ${d.fine}`;
 fetchRecent();
}

function show(src){ modal.style.display="flex"; big.src=src; }

async function fetchData(){
 let n=num.value.trim(); if(!n){ res.innerText="Enter vehicle number"; return; }
 let sdate=document.getElementById("startDate").value;
 let stime=document.getElementById("startTime").value;
 let url=api+"/api/get_vehicle/"+n;
 if(sdate) url+="?start="+sdate+(stime?"&start_time="+stime:"");
 let r=await fetch(url);
 let d=await r.json();
 if(d.status!=="found"){res.innerText=d.message; return;}

 let rec=d.record;
 let totalFine=0,totalPaid=0;
 rec.break.forEach(v=>{
   if(v.type==="FINE") totalFine+=v.amount;
   if(v.type==="PAY") totalPaid+=(-v.amount);
 });
 let remain=rec.fine;
 let color = remain===0 ? "statusGreen" : "statusRed";

 let h=`<p class="${color}">Remaining Due: ₹${remain}</p>
        <p>Total Fine: ₹${totalFine} | Total Paid: ₹${totalPaid}</p>
        <table>
        <tr><th>Type</th><th>Amount</th><th>Time</th><th>Img</th></tr>`;

 rec.break.forEach(v=>{
 h+=`<tr>
 <td>${v.type}</td>
 <td>${v.amount}</td>
 <td>${v.time}</td>
 <td>${v.img?`<img class='thumb' src="data:image/jpeg;base64,${v.img}" onclick="show(this.src)">`:"-"}</td>
 </tr>`;
 });
 h+="</table>"; res.innerHTML=h;
}

async function pay(){
 let n=pnum.value.trim(),a=parseInt(amt.value);
 if(!n || !a){ paymsg.innerText="Enter vehicle number & amount"; return; }
 let r=await fetch(api+"/api/pay_fine",{method:"POST",
 headers:{'Content-Type':'application/json'},
 body:JSON.stringify({number:n,amount:a})});
 let d=await r.json();
 paymsg.innerText=d.message;
}

async function fetchRecent(){
 let r=await fetch(api+"/api/recent_violations");
 let d=await r.json();
 let h="<table><tr><th>Plate</th><th>Time</th><th>Img</th></tr>";
 d.recent.forEach(v=>{
   h+=`<tr>
   <td>${v.plate}</td>
   <td>${v.time}</td>
   <td>${v.img?`<img class='thumb' src="data:image/jpeg;base64,${v.img}" onclick="show(this.src)">`:"-"}</td>
   </tr>`;
 });
 h+="</table>";
 recent.innerHTML=h;
}

// Auto-refresh recent violations every 5 seconds
setInterval(fetchRecent,5000);
fetchRecent();
</script>
</body>
</html>
