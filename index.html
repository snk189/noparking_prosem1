<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Traffic Violations</title>
<style>
body{font-family:Segoe UI;background:#f0f2f5;margin:0}
header{background:#0077ff;color:#fff;text-align:center;padding:18px;font-size:24px}
.container{max-width:850px;margin:25px auto;background:#fff;padding:20px;border-radius:10px}
button{background:#0077ff;color:#fff;border:0;padding:10px;border-radius:6px;cursor:pointer;margin-top:6px}
img.thumb{width:90px;border:3px solid #0077ff;margin:4px;cursor:pointer;border-radius:8px}
#modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
#modal img{max-width:90%;max-height:90%;border:5px solid #fff}
.statusGreen{color:green;font-weight:bold;font-size:20px}
.statusRed{color:red;font-weight:bold;font-size:20px}
</style>
</head>
<body>
<header>Parking & Traffic Violation Dashboard</header>
<div class="container">

<h3>Upload Car Image</h3>
<input type="file" id="img"><button onclick="add()">Submit</button>
<div id="msg"></div><hr>

<h3>Search Vehicle</h3>
<input id="num" placeholder="KA01AB1234">
<button onclick="fetchData()">Search</button>
<div id="res"></div><hr>

<h3>Pay Fine</h3>
<input id="pnum" placeholder="KA01AB1234">
<input type="number" id="amt" placeholder="Amount">
<button onclick="pay()">Pay</button>
<div id="paymsg"></div>

</div>

<div id="modal" onclick="this.style.display='none'"><img id="big"></div>

<script>
const api="http://127.0.0.1:8000";

async function add(){
 let f=img.files[0]; if(!f) return;
 let fd=new FormData(); fd.append("file",f);
 let r=await fetch(api+"/api/new_violation_image",{method:"POST",body:fd});
 let d=await r.json();
 if(d.status==='wait'){ msg.innerText=d.message; return; }
 msg.innerText=JSON.stringify(d);
}

function show(src){ modal.style.display="flex"; big.src=src; }

async function fetchData(){
 let n=num.value.trim(); if(!n) return;
 let r=await fetch(api+"/api/get_vehicle/"+n);
 let d=await r.json();
 if(d.status!=="found"){res.innerText=d.message; return;}

 let rec=d.record;
 let totalFine=0,totalPaid=0;
 rec.break.forEach(v=>{
   if(v.type==="FINE") totalFine+=v.amount;
   if(v.type==="PAY") totalPaid+=(-v.amount);
 });
 let remain=rec.fine;
 let color = remain===0 ? "statusGreen" : "statusRed";

 let h=`<p class="${color}">Remaining Due: ₹${remain}</p>
        <p>Total Fine: ₹${totalFine} | Total Paid: ₹${totalPaid}</p>
        <table border=1 cellpadding=6>
        <tr><th>Type</th><th>Amount</th><th>Time</th><th>Img</th></tr>`;

 rec.break.forEach(v=>{
 h+=`<tr>
 <td>${v.type}</td>
 <td>${v.amount}</td>
 <td>${v.time}</td>
 <td>${v.img?`<img class='thumb' src="data:image/jpeg;base64,${v.img}" onclick="show(this.src)">`:"-"}</td>
 </tr>`;
 });
 h+="</table>"; res.innerHTML=h;
}

async function pay(){
 let n=pnum.value.trim(),a=parseInt(amt.value);
 let r=await fetch(api+"/api/pay_fine",{method:"POST",
 headers:{'Content-Type':'application/json'},
 body:JSON.stringify({number:n,amount:a})});
 let d=await r.json();
 paymsg.innerText=d.message;
}
</script>
</body>
</html>
